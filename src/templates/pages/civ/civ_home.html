{% extends 'base.html' %}
{% load static %}
{% load utilities %}


{% block content %}
<div data-x='0' data-y='0' data-zoom='1' id="map-grid" class="grid grid-cols-2 grid-rows-2 w-screen h-screen justify-center items-center align-middle text-center">
    <div class="map-part h-full col-span-1 row-span-1 bg-cover" style="background: cover;" id="img-tl"></div>
    <div class="map-part h-full col-span-1 row-span-1 bg-cover" id="img-tr"></div>
    <div class="map-part h-full col-span-1 row-span-1 bg-cover" id="img-bl"></div>
    <div class="map-part h-full col-span-1 row-span-1 bg-cover" id="img-br"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", () => {
        let map = document.getElementById('map-grid');
        console.log(map);
        let start_x, start_y, end_x, end_y, delta_zoom;
        let is_dragging = false;

        function bindMapEvents() {
            console.log("binding...")
        
            const imageUrl = "media/images/mapaeuropy.jpg"; // Replace with your image URL
            
            let x = parseInt(map.dataset.x);
            let y = parseInt(map.dataset.y);
            let zoom = parseInt(map.dataset.zoom);
            console.log(x, y, zoom);
            map.addEventListener("mousedown", (e) => {
                is_dragging = true;
                start_x = e.clientX;
                start_y = e.clientY;
                map.classList.toggle('cursor-grabbing')
                console.log('mousedown');
            });

            document.addEventListener('mousemove', (e) => {
                if (is_dragging) {
                    const dx = e.clientX - start_x;
                    const dy = e.clientY - start_y;
                    map.style.left = `${initialX + dx}px`;
                    map.style.top = `${initialY + dy}px`;
                }
            });

            map.addEventListener("mouseup", (e) => {
                end_x = e.clientX;
                end_y = e.clientY;
                is_dragging = false;
                console.log(parseInt(start_x - end_x), typeof(parseInt(start_x - end_x)), x, typeof(x));
                console.log(parseInt(start_y - end_y), y);
                htmx.ajax('GET', '/civ/map?x=' + (x + parseInt(start_x - end_x)) + '&y=' + (y + parseInt(start_y - end_y)) + '&zoom=' + zoom, {target:'map-container', swap:'outerHTML'})
                console.log('mouseup');
            });

            window.addEventListener("wheel", (e) => {
                console.log("scrolling...", e.deltaY, typeof(e.deltaY));
                if (e.deltaY > 0) delta_zoom = 1;
                else delta_zoom = -1;
                htmx.ajax('GET', '/civ/map?x=' + x + '&y=' + y + '&zoom=' + (zoom + delta_zoom), {target:'map-container', swap:'outerHTML'})
            });

            document.getElementById('map-grid').ondragstart = function() { return false; };

                        // Function to set background image and position
                        const setImage = (element, position) => {
                element.style.backgroundImage = `url(${imageUrl})`;
                element.style.backgroundSize = `${zoom * 10}% ${zoom * 10}%`; // Ensure the image is zoomed to cover the entire grid
                element.style.backgroundPosition = position;
            };

            // Apply the image to each container with the appropriate position
            setImage(document.getElementById('img-tl'), '0% 0%');
            setImage(document.getElementById('img-tr'), '-100% 0%');
            setImage(document.getElementById('img-bl'), '0% -100%');
            setImage(document.getElementById('img-br'), '-100% -100%');
            console.log("map parts set");
        }

        bindMapEvents();

        document.addEventListener('htmx:afterRequest', (e) => {
            map = document.getElementById('map-grid');
            bindMapEvents();
        });
    });
</script>
{% endblock %}